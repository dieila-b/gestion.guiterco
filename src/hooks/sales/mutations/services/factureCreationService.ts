

import { supabase } from '@/integrations/supabase/client';
import type { CreateFactureVenteData } from '../types';

export const createFactureAndLines = async (data: CreateFactureVenteData) => {
  console.log('🔄 Création facture vente avec données:', data);
  
  // 1. Créer la facture TOUJOURS avec des statuts initiaux En attente
  const { data: facture, error: factureError } = await supabase
    .from('factures_vente')
    .insert({
      client_id: data.client_id,
      date_facture: new Date().toISOString(),
      montant_ht: data.montant_ht,
      tva: data.tva,
      montant_ttc: data.montant_ttc,
      mode_paiement: data.mode_paiement,
      statut_paiement: 'en_attente', // TOUJOURS en attente au début
      statut_livraison: 'En attente', // TOUJOURS en attente au début
      statut_livraison_id: 1, // ID pour 'En attente'
      numero_facture: '' // Will be auto-generated by trigger
    })
    .select()
    .single();

  if (factureError) {
    console.error('❌ Erreur création facture:', factureError);
    throw factureError;
  }

  console.log('✅ Facture créée avec statuts En attente:', facture);

  // 2. Créer les lignes de facture TOUJOURS avec statut En attente initialement
  const lignesFacture = data.cart.map(item => ({
    facture_vente_id: facture.id,
    article_id: item.article_id,
    quantite: item.quantite,
    prix_unitaire: item.prix_unitaire,
    prix_unitaire_brut: item.remise ? item.prix_unitaire + (item.remise || 0) : item.prix_unitaire, // Prix avant remise
    remise_unitaire: item.remise || 0, // Remise unitaire
    montant_ligne: item.quantite * item.prix_unitaire,
    statut_livraison: 'en_attente' // TOUJOURS En attente au début
  }));

  console.log('🔄 Création lignes facture avec statut En attente:', lignesFacture);

  const { data: lignesCreees, error: lignesError } = await supabase
    .from('lignes_facture_vente')
    .insert(lignesFacture)
    .select();

  if (lignesError) {
    console.error('❌ Erreur création lignes facture:', lignesError);
    throw lignesError;
  }

  console.log('✅ Lignes facture créées avec statut En attente:', lignesCreees);

  return { facture, lignes: lignesCreees };
};

